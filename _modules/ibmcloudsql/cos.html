
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ibmcloudsql.cos &#8212; ibmcloudsql alpha documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/custom.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">ibmcloudsql</a></h1>








<h3>Navigation</h3>
<p><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_query.html">SQLQuery Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_query.html#sqlclienttimeseries-class">SQLClientTimeSeries Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cos.html">COSClient Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_magic.html">SQLBuilder Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">IBMCloudAccess Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includeme.html">Github Repository</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ibmcloudsql.cos</h1><div class="highlight"><pre>
<span></span><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Copyright IBM Corp. 2020</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># flake8: noqa E203</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

<span class="kn">import</span> <span class="nn">ibm_boto3</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">ibm_botocore.client</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">IBMCloudAccess</span><span class="p">,</span> <span class="n">confirm_action</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">IBMCloudAccess</span><span class="p">,</span> <span class="n">confirm_action</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Helper class to interact with IBM Watson Studio projects</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ProjectLib"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ProjectLib">[docs]</a><span class="k">class</span> <span class="nc">ProjectLib</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is used by SQLClient/COSClient via :py:meth:`read` and :py:meth:`write` methods</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    project: project_lib.Project</span>
<span class="sd">        The object</span>

<span class="sd">            `from project_lib import Project`</span>
<span class="sd">    file_name: str</span>
<span class="sd">        The file_name where the data about SQL queries&#39; jobs should be read/stored</span>

<span class="sd">        The content of this file is used to track progress</span>

<span class="sd">    file_type: str, optional</span>
<span class="sd">        The file format of `file_name`</span>

<span class="sd">    .. todo::</span>

<span class="sd">        NOTE: Currently support only one file</span>

<span class="sd">        To support many files, we can switch to using dict such as self._data_out[file_name]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; map to real file name &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">file_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_type</span> <span class="o">=</span> <span class="n">file_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">file_type</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; file-like object: storing the file-content &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Project: the project-lib object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>

<div class="viewcode-block" id="ProjectLib.read"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ProjectLib.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read from project-lib&#39;s file into file-like object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            File name in the Watson Studio&#39;s project assets. If the file is not provided, then it reads the one passed into the object&#39;s constructor.</span>

<span class="sd">        file_type: str, optional</span>
<span class="sd">            The type of file, &quot;json&quot; or &quot;csv&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        file-like object:</span>
<span class="sd">            The content of the data, in dict (json) or pd.DataFrame (csv)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span>
        <span class="c1"># Fetch the file</span>
        <span class="n">file_is_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">get_files</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filename_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_name</span><span class="p">:</span>
                    <span class="n">file_is_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">file_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                        <span class="c1"># Read the CSV data file from the object storage into a pandas DataFrame</span>
                        <span class="n">file_content</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="c1"># import pandas as pd</span>
                        <span class="c1"># pd.read_json(my_file, nrows=10)</span>
                        <span class="kn">import</span> <span class="nn">json</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                        <span class="c1"># Read the CSV data file from the object storage into a pandas DataFrame</span>
                        <span class="n">file_content</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_is_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span></div>

<div class="viewcode-block" id="ProjectLib.write"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ProjectLib.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the file-like data back to project-lib&#39;s file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str</span>
<span class="sd">            File name</span>
<span class="sd">        file_type: str, optional</span>
<span class="sd">            The type of file, &quot;json&quot; or &quot;csv&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dict</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;asset_id&#39;: &#39;1deebaad-8ad3-4861-8c52-e714d8eef2a9&#39;,</span>
<span class="sd">            &#39;bucket_name&#39;: &#39;projectlib351fb93e171c44369663ff79b938828d&#39;,</span>
<span class="sd">            &#39;file_name&#39;: &#39;iris1.csv&#39;,</span>
<span class="sd">            &#39;message&#39;: &#39;File iris1.csv has been written successfully to the associated OS&#39;}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span>
                <span class="n">file_name</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">set_project_asset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span>
                <span class="n">file_name</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">set_project_asset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<span class="c1"># ---------------------------------------------------------------------------------------------</span>
<span class="c1"># Helper class to do client-side mapping of COS endpoints to aliases supported in SQL Query</span>
<span class="c1"># ---------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ParsedUrl"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl">[docs]</a><span class="k">class</span> <span class="nc">ParsedUrl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use this class to extract information from COS URL</span>

<span class="sd">    `cos://&lt;cos-name&gt;/&lt;bucket&gt;/&lt;prefix&gt;/`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Endpoints to change:</span>
<span class="sd">        https://cloud.ibm.com/docs/cloud-object-storage?topic=cloud-object-storage-migrate-data-center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dal-us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.dal.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dal&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.dal.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wdc-us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.wdc.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wdc&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.wdc.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sjc-us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.sjc.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sjc&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.sjc.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ams-eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ams.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ams&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ams.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fra-eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.fra.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fra&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.fra.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mil-eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mil.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mil&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mil.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us-south&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us-south.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us-east&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us-east.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ca-tor&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ca-tor.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jp-tok&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.jp-tok.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jp-osa&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.jp-osa.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;br-sao&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.br-sao.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ap&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tok-ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.tok.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tok&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.tok.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seo-ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.seo.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.seo.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hkg-ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.hkg.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hkg&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.hkg.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu-de&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu-de.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu-gb&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu-gb.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ams03&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ams03.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;che01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.che01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hkg02&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.hkg02.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mel01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mel01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mex01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mex01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mil01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mil01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tor01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.tor01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mon01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mon01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;osl01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.osl01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;par01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.par01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sao01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.sao01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seo01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.seo01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sjc04&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.sjc04.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sng01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.sng01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;au-syd&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.au-syd.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us-west&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us-west.cloud-object-storage.test.appdomain.cloud&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># https://cloud.ibm.com/docs/cloud-object-storage?topic=cloud-object-storage-endpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dedicated_endpoints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;s3.us-south.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.us-east.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.eu-gb.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.eu-de.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.au-syd.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.ca-tor.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.jp-tok.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.jp-osa.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.br-sao.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.us-west.cloud-object-storage.test.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="c1"># cross-region</span>
            <span class="s2">&quot;s3.us.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.eu.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.ap.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="c1"># single DC</span>
            <span class="s2">&quot;s3.ams03.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.che01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.hkg02.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.mex01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.mil01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.mon01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.osl01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.par01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.sjc04.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.sao01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.seo01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.sng01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s3.tor01.cloud-object-storage.appdomain.cloud&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ParsedUrl.get_exact_url"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_exact_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convert COS URL from using alias to exact URL&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="ParsedUrl.get_endpoint"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the endpoint string from COS URL&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span></div>

<div class="viewcode-block" id="ParsedUrl.get_bucket"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the bucket name from COS URL&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span></div>

<div class="viewcode-block" id="ParsedUrl.get_prefix"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">get_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the prefix part from COS URL&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">cos_url</span><span class="p">[</span><span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fourth_slash</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span></div>

<div class="viewcode-block" id="ParsedUrl.analyze_cos_url"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.analyze_cos_url">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_cos_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a namedtuple containing the 3 fields</span>

<span class="sd">        * bucket</span>
<span class="sd">        * endpoint</span>
<span class="sd">        * prefix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cos_url : str</span>
<span class="sd">            COS URL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cos_url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cos_url</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">cos_url</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;COSURL&quot;</span><span class="p">,</span> <span class="s2">&quot;endpoint bucket prefix&quot;</span><span class="p">)</span>
        <span class="n">mycontainer</span> <span class="o">=</span> <span class="n">nt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_endpoint</span><span class="p">(</span><span class="n">cos_url</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_prefix</span><span class="p">(</span><span class="n">cos_url</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mycontainer</span></div>

<div class="viewcode-block" id="ParsedUrl.is_valid_cos_url"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.is_valid_cos_url">[docs]</a>    <span class="k">def</span> <span class="nf">is_valid_cos_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate if a string is COS URL</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_url</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cos://&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">cos_url</span> <span class="o">=</span> <span class="n">cos_url</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cos_url</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">cos_url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="n">cos_url</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>
        <span class="k">if</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_endpoint</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">endpoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">endpoint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dedicated_endpoints</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div></div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Helper class to query information or manipulate data as objects on COS</span>
<span class="c1"># which can also be used from SQL Query</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<div class="viewcode-block" id="COSClient"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient">[docs]</a><span class="k">class</span> <span class="nc">COSClient</span><span class="p">(</span><span class="n">ParsedUrl</span><span class="p">,</span> <span class="n">IBMCloudAccess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class handles the interaction with IBM COS storage</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud_apikey : str, optional</span>
<span class="sd">        an account-level API key [manage/Access (IAM)/IBM Cloud API keys]</span>

<span class="sd">        https://cloud.ibm.com/docs/iam/users_roles.html</span>
<span class="sd">        https://cloud.ibm.com/docs/services/cloud-object-storage?topic=cloud-object-storage-getting-started</span>

<span class="sd">    cos_url : str, optional</span>
<span class="sd">        the COS URL where retrieved data is stored</span>

<span class="sd">    client_info : str, optional</span>
<span class="sd">        User-defined string</span>

<span class="sd">    thread_safe: bool, optional (=False)</span>
<span class="sd">        If thread-safe is used, a new Session object is created upon this object creation</span>

<span class="sd">    See also</span>
<span class="sd">    ---------</span>

<span class="sd">        * https://cloud.ibm.com/apidocs/cos/cos-configuration</span>
<span class="sd">        * https://ibm.github.io/ibm-cos-sdk-python/</span>
<span class="sd">        * https://cloud.ibm.com/docs/services/cloud-object-storage/iam?topic=cloud-object-storage-service-credentials</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cloud_apikey</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">cos_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">client_info</span><span class="o">=</span><span class="s2">&quot;COS Client&quot;</span><span class="p">,</span>
        <span class="n">staging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">thread_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">iam_max_tries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ParsedUrl</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">IBMCloudAccess</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">cloud_apikey</span><span class="o">=</span><span class="n">cloud_apikey</span><span class="p">,</span>
            <span class="n">client_info</span><span class="o">=</span><span class="n">client_info</span><span class="p">,</span>
            <span class="n">staging</span><span class="o">=</span><span class="n">staging</span><span class="p">,</span>
            <span class="n">iam_max_tries</span><span class="o">=</span><span class="n">iam_max_tries</span><span class="p">,</span>
            <span class="n">thread_safe</span><span class="o">=</span><span class="n">thread_safe</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cos_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_url</span> <span class="o">=</span> <span class="n">cos_url</span>
        <span class="c1"># a dict holding all retrieved bucket&#39;s information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># track Project-Lib object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_cos_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;we make use via the existing session object -</span>
<span class="sd">        not the default session object</span>

<span class="sd">        NOTE: The existing session object can also be a default session object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_new_s3_client</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create a low-level service client of COS from the default session</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span>
            <span class="k">assert</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
                <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">signature_version</span><span class="o">=</span><span class="s2">&quot;oauth&quot;</span><span class="p">),</span>
                <span class="n">endpoint_url</span><span class="o">=</span><span class="s2">&quot;https://</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">endpoint</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_safe</span><span class="p">:</span>
            <span class="c1"># So that we can avoid the issue of using single session</span>
            <span class="k">return</span> <span class="n">_get_new_s3_client</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_cos_client</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_default_cos_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a low-level service client of COS from the default session</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_get_default_s3_client</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create a low-level service client of COS from the default session</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span>
            <span class="k">assert</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">ibm_boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
                <span class="s2">&quot;s3&quot;</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">signature_version</span><span class="o">=</span><span class="s2">&quot;oauth&quot;</span><span class="p">),</span>
                <span class="n">endpoint_url</span><span class="o">=</span><span class="s2">&quot;https://</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">endpoint</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">_get_default_s3_client</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

<div class="viewcode-block" id="COSClient.copy_daily_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.copy_daily_objects">[docs]</a>    <span class="k">def</span> <span class="nf">copy_daily_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_cos_url</span><span class="p">,</span> <span class="n">target_cos_url</span><span class="p">,</span> <span class="n">buffer_days</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy all objects from a source location in a per day folder on a target location, with a sliding window buffer of days.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        source_cos_url: str</span>
<span class="sd">            Your source data in format cos://us-south/&lt;bucket-name&gt;/object_path/</span>

<span class="sd">        source_cos_url: str</span>
<span class="sd">            Your target data in format cos://us-south/&lt;bucket-name&gt;/object_path/</span>

<span class="sd">        buffer_days: sint</span>
<span class="sd">            Number of additional days before and after each day for which to copy the landed objects into the single target day folder.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if COS URL is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">source_cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">target_cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">source_cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">source_cos_url</span><span class="p">)</span>
        <span class="n">source_url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">source_cos_url</span><span class="p">)</span>
        <span class="n">target_cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">target_cos_url</span><span class="p">)</span>
        <span class="n">target_url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">target_cos_url</span><span class="p">)</span>
        <span class="n">target_prefix</span> <span class="o">=</span> <span class="n">target_url_parsed</span><span class="o">.</span><span class="n">prefix</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
                <span class="n">target_prefix</span> <span class="o">=</span> <span class="n">target_prefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">target_url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="n">source_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_cos_objects</span><span class="p">(</span><span class="n">source_cos_url</span><span class="p">)</span>
        <span class="n">source_objects</span><span class="p">[</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_objects</span><span class="p">[</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">source_objects</span><span class="o">.</span><span class="n">LastModified</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">source_objects</span><span class="o">.</span><span class="n">LastModified</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">current_objects</span> <span class="o">=</span> <span class="n">source_objects</span><span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">source_objects</span><span class="p">[</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span>
                    <span class="o">&gt;=</span> <span class="n">current_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">buffer_days</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">source_objects</span><span class="p">[</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span>
                    <span class="o">&lt;=</span> <span class="n">current_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">buffer_days</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">source_index</span><span class="p">,</span> <span class="n">source_object</span> <span class="ow">in</span> <span class="n">current_objects</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">current_source</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">source_url_parsed</span><span class="o">.</span><span class="n">bucket</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">source_object</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="s2">&quot;/_schema_as_json&quot;</span> <span class="ow">in</span> <span class="n">current_source</span>
                    <span class="ow">or</span> <span class="s2">&quot;/_checkpoint/&quot;</span> <span class="ow">in</span> <span class="n">current_source</span>
                <span class="p">):</span>
                    <span class="k">continue</span>  <span class="c1"># Don&#39;t copy SQL Query stream data landing checkpoint and schema objects.</span>
                <span class="n">current_target_object</span> <span class="o">=</span> <span class="n">source_object</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">][</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">source_url_parsed</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:</span>
                <span class="p">]</span>
                <span class="n">current_target_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_date_landed=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">target_prefix</span><span class="p">,</span> <span class="n">current_date</span>
                <span class="p">)</span>
                <span class="n">cos_client</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span>
                    <span class="n">Bucket</span><span class="o">=</span><span class="n">target_url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                    <span class="n">CopySource</span><span class="o">=</span><span class="n">current_source</span><span class="p">,</span>
                    <span class="n">Key</span><span class="o">=</span><span class="n">current_target_prefix</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">current_target_object</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_client</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span>
                    <span class="n">Body</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">Bucket</span><span class="o">=</span><span class="n">target_url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                    <span class="n">Key</span><span class="o">=</span><span class="n">current_target_prefix</span> <span class="o">+</span> <span class="s2">&quot;/_SUCCESS&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Copied </span><span class="si">{}</span><span class="s2"> objects to bucket </span><span class="si">{}</span><span class="s2"> into folder </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">current_objects</span><span class="p">),</span>
                        <span class="n">target_url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                        <span class="n">current_target_prefix</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="COSClient.list_cos_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.list_cos_objects">[docs]</a>    <span class="k">def</span> <span class="nf">list_cos_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">,</span> <span class="n">size_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_by_size</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all objects in the current COS URL. Also, please read the note to see the role of trailing slash in the COS URL.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        url: str</span>
<span class="sd">            A URI prefix. e.g., cos://us-south/&lt;bucket-name&gt;/object_path/</span>

<span class="sd">        size_unit: str, optional (&quot;B&quot; = byte)</span>
<span class="sd">            A value indicate the unit of &quot;Size&quot; column.</span>
<span class="sd">            [&quot;B&quot;, &quot;KB&quot;, &quot;MB&quot;, &quot;GB&quot;]</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The following columns (&quot;Object&quot;, &quot;Size&quot;, &quot;StorageClass&quot;)</span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>
<span class="sd">        Having a trailing slash (/) makes a difference in the returned result, as an asterisk is added at the end. So,</span>
<span class="sd">        &quot;/prefix&quot; would consider things like &quot;/prefix_unexpected/value&quot; and &quot;/prefix/expected_value&quot;; while</span>
<span class="sd">        &quot;/prefix/&quot; only consider &quot;/prefix/expected_value&quot;.</span>

<span class="sd">        Examples</span>
<span class="sd">        ------------</span>
<span class="sd">            Only &quot;list_objects&#39; work for IBM COS, not &#39;list_objects_v2&#39;</span>

<span class="sd">            `IBM-COS-SDK &lt;https://ibm.github.io/ibm-cos-sdk-python/reference/services/s3.html#S3.Client.list_objects_v2&gt;`_</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if COS URL is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">size_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size_unit</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects&quot;</span><span class="p">)</span>
        <span class="n">page_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span>
            <span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Contents&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="c1"># print(page[&#39;Contents&#39;])</span>
                <span class="n">page_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s2">&quot;Contents&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">page_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_df</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ETag&quot;</span><span class="p">,</span> <span class="s2">&quot;Owner&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Object&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;TB&quot;</span><span class="p">:</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="s2">&quot;GB&quot;</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s2">&quot;MB&quot;</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s2">&quot;KB&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">assert</span> <span class="n">size_unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">Size</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">Size</span> <span class="o">/</span> <span class="n">mapping</span><span class="p">[</span><span class="n">size_unit</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sort_by_size</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Size&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="k">def</span> <span class="nf">_get_tags_for_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">cos_objects_df</span><span class="p">):</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">objects_tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">,</span> <span class="s1">&#39;Tag_Key&#39;</span><span class="p">,</span> <span class="s1">&#39;Tag_Value&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">cos_objects_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">=</span><span class="n">cos_objects_df</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_object_tagging</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">tags_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;TagSet&#39;</span><span class="p">])</span>
            <span class="n">tags_df</span> <span class="o">=</span> <span class="n">tags_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Tag_Key&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;Tag_Value&quot;</span><span class="p">})</span>
            <span class="n">tags_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Object&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">)</span>
            <span class="n">objects_tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">objects_tags</span><span class="p">,</span> <span class="n">tags_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">objects_tags</span>

<div class="viewcode-block" id="COSClient.export_tags_for_cos_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.export_tags_for_cos_objects">[docs]</a>    <span class="k">def</span> <span class="nf">export_tags_for_cos_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">,</span> <span class="n">export_target_cos_file</span><span class="p">):</span>
        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_objects_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_cos_objects</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">objects_tags_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tags_for_objects</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">cos_objects_df</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">pyarrow</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
        <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">):</span>
            <span class="n">objects_tags_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
                <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objects_tags_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
                <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">,</span>
                <span class="n">fname</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">export_target_cos_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">export_target_cos_file</span><span class="p">)</span>
        <span class="n">export_target_url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">export_target_cos_file</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">export_target_url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">cos_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span>
            <span class="n">Bucket</span><span class="o">=</span><span class="n">export_target_url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">export_target_url_parsed</span><span class="o">.</span><span class="n">prefix</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exported </span><span class="si">{}</span><span class="s2"> object tags to </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2"> objects in location </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">objects_tags_df</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="n">export_target_cos_file</span><span class="p">,</span>
            <span class="n">cos_objects_df</span><span class="p">[</span><span class="s2">&quot;Object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="n">cos_url</span>
        <span class="p">))</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="COSClient.delete_empty_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.delete_empty_objects">[docs]</a>    <span class="k">def</span> <span class="nf">delete_empty_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete zero-size objects. Reference to :meth:`.list_cos_objects` for further details.</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if COS URL is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">result_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_cos_objects</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span>
        <span class="n">max_row_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_row_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Size</span><span class="p">[</span><span class="n">row</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="n">row</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_get_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_string</span><span class="p">,</span> <span class="n">result_location</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return upt-to-1000 objects [as constrained by</span>
<span class="sd">        https://ibm.github.io/ibm-cos-sdk-python/reference/services/s3.html]</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        list of dict</span>
<span class="sd">            The element in the list is a dict which contains a single key &quot;Key&quot;,</span>
<span class="sd">            with value as the suffix (after the bucketname until the end of COS URL)</span>

<span class="sd">            Return empty list if there is no object or can&#39;t read the COS URL</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">http_string</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,)</span>

        <span class="n">bucket_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;s3&quot;</span><span class="p">:</span> <span class="s2">&quot;http://s3.amazonaws.com/doc/2006-03-01/&quot;</span><span class="p">}</span>
            <span class="n">responseBodyXMLroot</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;s3:Name&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">bucket_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;s3:Contents&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;s3:Contents&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;s3:Key&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
                    <span class="n">bucket_objects</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Result object listing for COS URL at </span><span class="si">{}</span><span class="s2"> failed with http code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">result_location</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">bucket_objects</span>

<div class="viewcode-block" id="COSClient.delete_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.delete_objects">[docs]</a>    <span class="k">def</span> <span class="nf">delete_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">confirm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">get_result</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete all objects stored at the given COS URL</span>

<span class="sd">        https://&lt;cos-url&gt;/&lt;bucket&gt;?prefix=&lt;prefix-path&gt;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        confirm: bool, default=False</span>
<span class="sd">            confirm before deleting</span>
<span class="sd">        get_result: bool, default=True</span>
<span class="sd">            return the result, can be slow on large number of objects</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A single column dataframe: [&quot;Deleted Object&quot;]</span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>

<span class="sd">        Reference: `AWS doc &lt;https://awsdocs.s3.amazonaws.com/S3/latest/s3-qrc.pdf&gt;`_</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            curl -XGET \</span>
<span class="sd">                --url &quot;https://&lt;COS-exact-URL&gt;/&lt;bucket-name&gt;?prefix=&lt;YOUR_PREFIX&gt;&quot;</span>

<span class="sd">            https://s3.us-south.objectstorage.softlayer.net/sql-query-cos-access-ts?prefix=aiops/Location=us-south/DC=rgdal10/Year=2020/Month=02/Date=06</span>

<span class="sd">            response.content returns a string in XML format</span>
<span class="sd">            -----------</span>
<span class="sd">            (&#39; response = b\&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; &#39;</span>
<span class="sd">            &#39;standalone=&quot;yes&quot;?&gt;&lt;ListBucketResult &#39; &#39;xmlns=&quot;http://s3.amazonaws.com/doc/2006-03-01/&quot;&gt;</span>
<span class="sd">            &lt;Name&gt;sql-query-cos-access-ts&lt;/Name&gt;</span>
<span class="sd">            &lt;Prefix&gt;aiops/Location=us-south/DC=rgdal10/Year=2020/Month=02/Date=05&lt;/Prefix&gt;</span>
<span class="sd">            &lt;Marker&gt;&lt;/Marker&gt;</span>
<span class="sd">            &lt;MaxKeys&gt;1000&lt;/MaxKeys&gt;</span>
<span class="sd">            &lt;Delimiter&gt;&lt;/Delimiter&gt;</span>
<span class="sd">            &lt;IsTruncated&gt;false&lt;/IsTruncated&gt;</span>

<span class="sd">            --&gt; 0 or more</span>
<span class="sd">            &lt;Contents&gt;</span>
<span class="sd">                   &lt;Key&gt;aiops/Location=us-south/DC=rgdal10/Year=2020/Month=02/Date=05/Hour=1/part-00066-fd76d4c7-ea0a-40c3-8170-8f281a19ab5f-attempt_20200310232241_0027_m_000066_0.c000.snappy.parquet&lt;/Key&gt;</span>
<span class="sd">                   &lt;LastModified&gt;2020-03-10T23:26:55.957Z&lt;/LastModified&gt;</span>
<span class="sd">                   &lt;ETag&gt;&amp;quot;9b9c012a341fe7f4b9988c59cab96757&amp;quot;&lt;/ETag&gt;</span>
<span class="sd">                   &lt;Size&gt;1771294485&lt;/Size&gt;</span>
<span class="sd">                   &lt;Owner&gt;</span>
<span class="sd">                        &lt;ID&gt;899ab340-5a4d-4ae2-a1f7-5e39299735b4&lt;/ID&gt;</span>
<span class="sd">                        &lt;DisplayName&gt;899ab340-5a4d-4ae2-a1f7-5e39299735b4&lt;/DisplayName&gt;&lt;/Owner&gt;</span>
<span class="sd">                   &lt;StorageClass&gt;STANDARD&lt;/StorageClass&gt;&lt;/Contents&gt;</span>

<span class="sd">            &lt;/ListBucketResult&gt;\&#39;&#39;)</span>

<span class="sd">        As the entity tag (ETag) is a hash of the object, we can use it to reliably check whether the object has changed - better</span>
<span class="sd">        than just file size and modification date. Sample code to handle `request.response &lt;https://sdbrett.com/BrettsITBlog/2017/03/python-parsing-api-xml-response-data/&gt;`_</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if COS URL is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="c1">#print(&quot;COS URL: {}\n&quot;.format(cos_url))</span>
        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">result_location</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;cos&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="n">fourth_slash</span> <span class="o">=</span> <span class="n">result_location</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">http_string</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">result_location</span><span class="p">[:</span><span class="n">fourth_slash</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;?prefix=&quot;</span>
            <span class="o">+</span> <span class="n">result_location</span><span class="p">[</span><span class="n">fourth_slash</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pprint</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;http request </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">http_string</span><span class="p">))</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="s2">&quot; response = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Deleted Object&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">deleted_list_df</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">confirm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="n">confirm_action</span><span class="p">(</span><span class="s2">&quot;delete </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">))</span>

        <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Deleted Object&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">answer</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
            <span class="n">bucket_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="n">first_check</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">bucket_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_objects</span><span class="p">(</span><span class="n">http_string</span><span class="p">,</span> <span class="n">result_location</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket_objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">first_check</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_objects</span><span class="p">(</span>
                        <span class="n">cos_client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">bucket_objects</span><span class="p">,</span> <span class="n">deleted_list_df</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">first_check</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;There are no result objects for the COS URL </span><span class="si">{url}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">url</span><span class="o">=</span><span class="n">cos_url</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">deleted_list_df</span></div>

    <span class="k">def</span> <span class="nf">_delete_objects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cos_client</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">bucket_objects</span><span class="p">,</span> <span class="n">deleted_list_df</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; delete up-to 1000 objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_objects</span><span class="p">(</span>
            <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Delete</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Objects&quot;</span><span class="p">:</span> <span class="n">bucket_objects</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">deleted_list_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">deleted_object</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Deleted&quot;</span><span class="p">]:</span>
                <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">deleted_list_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[{</span><span class="s2">&quot;Deleted Object&quot;</span><span class="p">:</span> <span class="n">deleted_object</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]}],</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">deleted_list_df</span>

    <span class="k">def</span> <span class="nf">_list_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all objects from a given COS URL</span>

<span class="sd">        TO BE REMOVED</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cos_url {str} -- The COS URL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects&quot;</span><span class="p">)</span>
        <span class="n">page_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span>
            <span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Contents&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="c1"># print(page[&#39;Contents&#39;])</span>
                <span class="n">page_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s2">&quot;Contents&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">page_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_df</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ETag&quot;</span><span class="p">,</span> <span class="s2">&quot;Owner&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Object&quot;</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="COSClient.get_bucket_info"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.get_bucket_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_bucket_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>  <span class="c1"># noqa: E501</span>
        <span class="sd">&quot;&quot;&quot; Return the information of the given bucket</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if invalid COS URL</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            curl https://config.cloud-object-storage.cloud.ibm.com/v1/b/my-bucket \</span>
<span class="sd">            -H &#39;authorization: bearer &lt;IAM_token&gt;&#39;</span>

<span class="sd">        200 status code:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # NOTE: long strings are broken using ( sub1, sub2)</span>
<span class="sd">            {</span>
<span class="sd">            &quot;name&quot;: &quot;my-new-bucket&quot;,</span>
<span class="sd">            &quot;crn&quot;: (&quot;crn:v1:bluemix:public:cloud-object-storage:global:&quot;</span>
<span class="sd">                &quot;a/ 3bf0d9003abfb5d29761c3e97696b71c:xxxxxxx-6c4f-4a62-a165-696756d63903:bucket:my-new-bucket&quot;),</span>
<span class="sd">            &quot;service_instance_id&quot;: &quot;xxxxxxx-6c4f-4a62-a165-696756d63903&quot;,</span>
<span class="sd">            &quot;service_instance_crn&quot;: (&quot;crn:v1:bluemix:public:cloud-object-storage:global&quot;</span>
<span class="sd">                &quot;:a/3bf0d9003abfb5d29761c3e97696b71c:xxxxxxx-6c4f-4a62-a165-696756d63903::&quot;),</span>
<span class="sd">            &quot;time_created&quot;: &quot;2018-03-26T16:23:36.980Z&quot;,</span>
<span class="sd">            &quot;time_updated&quot;: &quot;2018-10-17T19:29:10.117Z&quot;,</span>
<span class="sd">            &quot;object_count&quot;: 764265234,</span>
<span class="sd">            &quot;bytes_used&quot;: 28198745752445144</span>
<span class="sd">            }</span>

<span class="sd">        .. todo::</span>

<span class="sd">            https://cloud.ibm.com/apidocs/cos/cos-configuration?code=python</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">cos_config.resource_configuration_v1</span> <span class="kn">import</span> <span class="n">ResourceConfigurationV1</span>

        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">ResourceConfigurationV1</span><span class="p">(</span><span class="n">iam_apikey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_bucket_config</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
            <span class="k">return</span> <span class="n">config</span></div>
        <span class="c1"># bucket = ParsedUrl().get_bucket(cos_url)</span>
        <span class="c1"># response = requests.get(</span>
        <span class="c1">#     &quot;https://config.cloud-object-storage.cloud.ibm.com/v1/b/{bucket}&quot;.</span>
        <span class="c1">#     format(bucket=bucket),</span>
        <span class="c1">#     headers=self.request_headers,</span>
        <span class="c1"># )</span>

        <span class="c1"># if response.status_code == 200 or response.status_code == 201:</span>
        <span class="c1">#     status_response = response.json()</span>
        <span class="c1">#     jobStatus = status_response[&#39;status&#39;]</span>
        <span class="c1">#     if jobStatus == &#39;completed&#39;:</span>
        <span class="c1">#         break</span>
        <span class="c1">#     if jobStatus == &#39;failed&#39;:</span>
        <span class="c1">#         print(&quot;Job {} has failed&quot;.format(jobId))</span>
        <span class="c1">#         break</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(&quot;Job status check failed with http code {}&quot;.format(</span>
        <span class="c1">#         response.status_code))</span>
        <span class="c1">#     break</span>
        <span class="c1"># time.sleep(2)</span>

    <span class="k">def</span> <span class="nf">_update_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the bucket given by COS URL</span>

<span class="sd">        .. todo::</span>

<span class="sd">           revise this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">cos_config.resource_configuration_v1</span> <span class="kn">import</span> <span class="n">ResourceConfigurationV1</span>

        <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apikey</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">ResourceConfigurationV1</span><span class="p">(</span><span class="n">iam_apikey</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>

        <span class="n">client</span><span class="o">.</span><span class="n">update_bucket_config</span><span class="p">(</span>
            <span class="n">bucket</span><span class="p">,</span> <span class="n">firewall</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allowed_ip&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.142.175.0/22&quot;</span><span class="p">,</span> <span class="s2">&quot;10.198.243.79&quot;</span><span class="p">]}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_object_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">,</span>
        <span class="n">smallest_size</span><span class="p">,</span>
        <span class="n">largest_size</span><span class="p">,</span>
        <span class="n">oldest_modification</span><span class="p">,</span>
        <span class="n">newest_modification</span><span class="p">,</span>
        <span class="n">smallest_object</span><span class="p">,</span>
        <span class="n">largest_object</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return statistics for objects&quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;Size&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">smallest_size</span><span class="p">:</span>
            <span class="n">smallest_size</span> <span class="o">=</span> <span class="n">size</span>
            <span class="n">smallest_object</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">largest_size</span><span class="p">:</span>
            <span class="n">largest_size</span> <span class="o">=</span> <span class="n">size</span>
            <span class="n">largest_object</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;LastModified&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modified</span> <span class="o">&lt;</span> <span class="n">oldest_modification</span><span class="p">:</span>
            <span class="n">oldest_modification</span> <span class="o">=</span> <span class="n">modified</span>
        <span class="k">if</span> <span class="n">modified</span> <span class="o">&gt;</span> <span class="n">newest_modification</span><span class="p">:</span>
            <span class="n">newest_modification</span> <span class="o">=</span> <span class="n">modified</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">smallest_size</span><span class="p">,</span>
            <span class="n">largest_size</span><span class="p">,</span>
            <span class="n">oldest_modification</span><span class="p">,</span>
            <span class="n">newest_modification</span><span class="p">,</span>
            <span class="n">smallest_object</span><span class="p">,</span>
            <span class="n">largest_object</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="COSClient.get_cos_summary"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.get_cos_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_cos_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return information for the given COR URL (may include bucket + prefix)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dict with keys</span>
<span class="sd">                &quot;largest_object&quot;</span>
<span class="sd">                &quot;largest_object_size&quot;</span>
<span class="sd">                &quot;newest_object_timestamp&quot;</span>
<span class="sd">                &quot;oldest_object_timestamp&quot;</span>
<span class="sd">                &quot;smallest_object&quot;</span>
<span class="sd">                &quot;smallest_object_size&quot;</span>
<span class="sd">                &quot;total_objects&quot;</span>
<span class="sd">                &quot;total_volume&quot;</span>
<span class="sd">                &quot;url&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Example: self.get_cos_summary_demo()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">sizeof_fmt</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1024.0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%3.1f</span><span class="s2"> </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="n">num</span> <span class="o">/=</span> <span class="mf">1024.0</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="n">paginator</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects&quot;</span><span class="p">)</span>
        <span class="n">page_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span>
            <span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span>
        <span class="p">)</span>

        <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">smallest_size</span> <span class="o">=</span> <span class="mi">9999999999999999</span>
        <span class="n">largest_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oldest_modification</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">newest_modification</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">smallest_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">largest_object</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Contents&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">page</span><span class="p">[</span><span class="s2">&quot;Contents&quot;</span><span class="p">]:</span>
                    <span class="p">(</span>
                        <span class="n">smallest_size</span><span class="p">,</span>
                        <span class="n">largest_size</span><span class="p">,</span>
                        <span class="n">oldest_modification</span><span class="p">,</span>
                        <span class="n">newest_modification</span><span class="p">,</span>
                        <span class="n">smallest_object</span><span class="p">,</span>
                        <span class="n">largest_object</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_object_stats</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="n">smallest_size</span><span class="p">,</span>
                        <span class="n">largest_size</span><span class="p">,</span>
                        <span class="n">oldest_modification</span><span class="p">,</span>
                        <span class="n">newest_modification</span><span class="p">,</span>
                        <span class="n">smallest_object</span><span class="p">,</span>
                        <span class="n">largest_object</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">total_size</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;Size&quot;</span><span class="p">])</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smallest_size</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">oldest_modification</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">newest_modification</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oldest_modification</span> <span class="o">=</span> <span class="n">oldest_modification</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y, %HH:%MM:%SS&quot;</span><span class="p">)</span>
            <span class="n">newest_modification</span> <span class="o">=</span> <span class="n">newest_modification</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y, %HH:%MM:%SS&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;total_objects&quot;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
            <span class="s2">&quot;total_volume&quot;</span><span class="p">:</span> <span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">total_size</span><span class="p">),</span>
            <span class="s2">&quot;oldest_object_timestamp&quot;</span><span class="p">:</span> <span class="n">oldest_modification</span><span class="p">,</span>
            <span class="s2">&quot;newest_object_timestamp&quot;</span><span class="p">:</span> <span class="n">newest_modification</span><span class="p">,</span>
            <span class="s2">&quot;smallest_object_size&quot;</span><span class="p">:</span> <span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">smallest_size</span><span class="p">),</span>
            <span class="s2">&quot;smallest_object&quot;</span><span class="p">:</span> <span class="n">smallest_object</span><span class="p">,</span>
            <span class="s2">&quot;largest_object_size&quot;</span><span class="p">:</span> <span class="n">sizeof_fmt</span><span class="p">(</span><span class="n">largest_size</span><span class="p">),</span>
            <span class="s2">&quot;largest_object&quot;</span><span class="p">:</span> <span class="n">largest_object</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="COSClient.copy_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.copy_objects">[docs]</a>    <span class="k">def</span> <span class="nf">copy_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Upload a file to a given COS URL</span>

<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        ValueError</span>
<span class="sd">            if COS URL is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not a valid COS URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># result_objects = self.list_cos_objects(cos_url)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File uploaded&quot;</span><span class="p">)</span></div>

    <span class="c1"># -----------------</span>
    <span class="c1"># The methods below are for interacting with a file stored as an asset in a Watson Studio&#39;s Project.</span>
    <span class="c1"># -----------------</span>
<div class="viewcode-block" id="COSClient.connect_project_lib"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.connect_project_lib">[docs]</a>    <span class="k">def</span> <span class="nf">connect_project_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to an IBM Watson Studio Project&#39;s COS bucket for its own assets</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project: Project</span>
<span class="sd">            The project-lib object</span>

<span class="sd">        file_name: str, optional</span>
<span class="sd">            The name of the file in ProjectLib&#39;s COS bucket where data will be read/stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="n">ProjectLib</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_project_lib_data</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="COSClient.read_project_lib_data"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.read_project_lib_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_project_lib_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;read the content from the given file (via ProjectLib in IBM Watson Studio&#39;s COS bucket)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            If not specified, use the one defined from the beginning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Please connect to your ProjectLib object with `connect_project_lib` API&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="COSClient.write_project_lib_data"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.write_project_lib_data">[docs]</a>    <span class="k">def</span> <span class="nf">write_project_lib_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write the content to the given file (via ProjectLib in IBM Watson Studio&#39;s COS bucket)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            If not specified, use the one defined from the beginning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Please connect to your ProjectLib object with `connect_project_lib` API&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Project: IBM Watson Studio ProjectLib object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2020, IBM Research.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>